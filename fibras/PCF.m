%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Entradas:
% bombeio =                         sinal =           
%    N_Bombeios: int(m)                     lambda: [1xn] 
%        lambda: [1xm]                    N_Sinais: int(n)
%             P: [1xm]                         Bws: double
%           Bwp: double                        
%           FPL: double                        
%Saída:
% fibra =
%           L: double
%       alfas: [1xn]
%       alfap: [1xm]
%   alfasdBkm: [1xn]
%   alfapdBkm: [1xm]
% Crpicosinal: [1xn]
%  Crpicopump: [1xm]
%    Crnormal: [1xK]
%     sepfreq: [1xK]
%       Aeffs: [1xn]
%       Aeffp: [1xm]       
%          KR: double % Constante que depende do material dopante da fibra
%          NA: double % Abertura numérica da fibra
%          no: double % Índice de Refração do núcleo da fibra
%      beta1s: [1xn]  *
%      beta2s: [1xn]  *
%      beta3s: [1xn]  *
%      beta1p: [1xm]  *
%      beta2p: [1xm]  *
%      beta3p: [1xm]  *
%       gamas: [1xn]  *
%       gamap: [1xm]  *
% * Utilizado somente no código de análise de sinais.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function fibra = PCF(bombeio, sinal, alfac)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               Atenuação                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% alfa para 
lamb = [1402.88248337029 1404.43458980044 1405.98669623060 1407.53880266075...
        1409.09090909091 1410.64301552106 1412.19512195122 1416.85144124169...
        1419.95565410200 1423.05986696231 1426.16407982262 1430.82039911308...
        1435.47671840355 1438.58093126386 1443.23725055432 1449.44567627494...
        1457.20620842572 1461.86252771619 1468.07095343681 1475.83148558758...
        1483.59201773836 1491.35254988914 1502.21729490022 1511.52993348115...
        1520.84257206208 1533.25942350333 1544.12416851441 1551.88470066519...
        1565.85365853659 1579.82261640798 1595.34368070953 1609.31263858093...
        1618.62527716186 1632.59423503326 1643.45898004435];
    
alfa = [12.9006685082873 12.4034309392265 11.7956961325967 11.0774640883978...
        10.6630994475138 10.1934861878453 9.36475690607735 8.56365193370166...
        8.03879005524862 7.65204972375691 7.21006077348066 6.85094475138122...
        6.51945303867403 6.32608287292818 6.07746408839779 5.82884530386740...
        5.58022651933702 5.46972928176796 5.35923204419890 5.24873480662983...
        5.19348618784530 5.11061325966851 5.05536464088398 5.02774033149171...
        5.02774033149171 5.02774033149171 5.00011602209945 5.00011602209945...
        5.00011602209945 5.02774033149171 5.05536464088398 5.05536464088398...
        5.08298895027624 5.08298895027624 5.11061325966851];

if nargin == 3
    alfa = (alfa - 5) + alfac;
end

fibra.alfasdBkm = spline(lamb, alfa, sinal.lambda);
fibra.alfapdBkm = spline(lamb, alfa, bombeio.lambda);

fibra.alfas = fibra.alfasdBkm*log(10)*1e-4;  % (neper/m)
fibra.alfap = fibra.alfapdBkm*log(10)*1e-4;
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                   Calculo do ganho de Raman                           %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

CRPICO = 21.19;       %(W^-1*km^-1) Coeficiente de Raman de pico
fibra.Crpicopump = CRPICO*1e-3*ones(1,bombeio.N_Bombeios);
fibra.Crpicosinal = CRPICO*1e-3*ones(1,sinal.N_Sinais);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%              Pontos da curva de ganho normalizada                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.Crnormal = [ 0.0180722891566265,0.0220883534136546,0.0341365461847390,...
    0.0502008032128514,0.0783132530120482,0.0903614457831325,0.112449799196787,...
    0.138554216867470,0.158634538152610,0.188755020080321,0.206827309236948,...
    0.220883534136546,0.238955823293173,0.255020080321285,0.273092369477912,...
    0.285140562248996,0.303212851405623,0.317269076305221,0.325301204819277,...
    0.335341365461847,0.341365461847390,0.341365461847390,0.343373493975904,...
    0.347389558232932,0.353413654618474,0.361445783132530,0.371485943775100,...
    0.381526104417671,0.389558232931727,0.399598393574297,0.415662650602410,...
    0.429718875502008,0.443775100401606,0.459839357429719,0.475903614457831,...
    0.493975903614458,0.506024096385542,0.522088353413655,0.530120481927711,...
    0.550200803212851,0.574297188755020,0.602409638554217,0.636546184738956,...
    0.668674698795181,0.692771084337349,0.712851405622490,0.732931726907630,...
    0.755020080321285,0.773092369477912,0.797188755020080,0.817269076305221,...
    0.841365461847390,0.861445783132530,0.881526104417671,0.913654618473896,...
    0.935742971887550,0.973895582329317,0.985943775100402,0.995983935742972,...
    0.997991967871486,1,0.989959839357430,0.977911646586345,0.961847389558233,...
    0.945783132530120,0.933734939759036,0.929718875502008,0.937751004016064,...
    0.951807228915663,0.961847389558233,0.971887550200803,0.975903614457831,...
    0.967871485943775,0.939759036144578,0.913654618473896,0.895582329317269,...
    0.875502008032128,0.861445783132530,0.797188755020080,0.763052208835341,...
    0.718875502008032,0.666666666666667,0.620481927710843,0.564257028112450,...
    0.504016064257028,0.443775100401606,0.409638554216867,0.373493975903614,...
    0.325301204819277,0.291164658634538,0.265060240963855,0.248995983935743,...
    0.228915662650602,0.214859437751004,0.212851405622490,0.226907630522088,...
    0.246987951807229,0.267068273092369,0.285140562248996,0.303212851405623,...
    0.309236947791165,0.299196787148594,0.285140562248996,0.267068273092369,...
    0.246987951807229,0.224899598393574,0.202811244979920,0.190763052208835,...
    0.172690763052209,0.154618473895582,0.138554216867470,0.124497991967871,...
    0.108433734939759,0.0923694779116466,0.0843373493975904,0.0843373493975904,...
    0.0823293172690763,0.0843373493975904,0.0803212851405623];
        
fibra.sepfreq = [0.000000E+000,1.428571E+011,3.142857E+011,4.285714E+011,6.000000E+011...
    6.571429E+011,8.285714E+011,9.714286E+011,1.085714E+012,1.285714E+012,1.342857E+012,...
    1.485714E+012,1.657143E+012,1.885714E+012,2.228571E+012,2.485714E+012,2.714286E+012,...
    2.942857E+012,3.142857E+012,3.371429E+012,3.571429E+012,3.771429E+012,4.000000E+012,...
    4.285714E+012,4.485714E+012,4.657143E+012,4.942857E+012,5.171429E+012,5.400000E+012,...
    5.600000E+012,5.885714E+012,6.085714E+012,6.314286E+012,6.542857E+012,6.685714E+012,...
    6.971429E+012,7.142857E+012,7.342857E+012,7.514286E+012,7.685714E+012,8.000000E+012,...
    8.200000E+012,8.485714E+012,8.771429E+012,9.028571E+012,9.200000E+012,9.400000E+012,...
    9.600000E+012,9.742857E+012,1.005714E+013,1.022857E+013,1.045714E+013,1.065714E+013,...
    1.094286E+013,1.137143E+013,1.160000E+013,1.202857E+013,1.228571E+013,1.257143E+013,...
    1.285714E+013,1.305714E+013,1.328571E+013,1.342857E+013,1.351429E+013,1.362857E+013,...
    1.374286E+013,1.385714E+013,1.397143E+013,1.408571E+013,1.414286E+013,1.422857E+013,...
    1.431429E+013,1.442857E+013,1.454286E+013,1.462857E+013,1.465714E+013,1.468571E+013,...
    1.471429E+013,1.480000E+013,1.485714E+013,1.488571E+013,1.497143E+013,1.502857E+013,...
    1.511429E+013,1.520000E+013,1.534286E+013,1.542857E+013,1.554286E+013,1.571429E+013,...
    1.594286E+013,1.614286E+013,1.634286E+013,1.668571E+013,1.705714E+013,1.731429E+013,...
    1.751429E+013,1.765714E+013,1.777143E+013,1.788571E+013,1.800000E+013,1.811429E+013,...
    1.825714E+013,1.834286E+013,1.842857E+013,1.851429E+013,1.860000E+013,1.871429E+013,...
    1.877143E+013,1.888571E+013,1.902857E+013,1.922857E+013,1.945714E+013,1.962857E+013,...
    1.988571E+013,2.022857E+013,2.048571E+013,2.071429E+013,2.088571E+013,2.102857E+013];
                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                             Área Efetiva                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comprimento de onda de referência = 1550 nm
Aeff_1550 = 1.81;

lamb  = 1400:1649; 
Aeff_ref = [0.86858 0.86937 0.87015 0.87094 0.87172 0.87251 0.87330 ...
            0.87408 0.87487 0.87566 0.87644 0.87723 0.87801 0.87880 ...
            0.87972 0.88050 0.88129 0.88208 0.88286 0.88365 0.88443 ...
            0.88535 0.88614 0.88692 0.88771 0.88850 0.88941 0.89020 ...
            0.89099 0.89177 0.89269 0.89347 0.89426 0.89518 0.89596 ...
            0.89675 0.89754 0.89845 0.89924 0.90003 0.90094 0.90173 ...
            0.90252 0.90343 0.90422 0.90514 0.90592 0.90671 0.90763 ...
            0.90841 0.90933 0.91012 0.91103 0.91182 0.91274 0.91352 ...
            0.91444 0.91523 0.91614 0.91693 0.91785 0.91863 0.91955 ...
            0.92034 0.92125 0.92204 0.92296 0.92387 0.92466 0.92558 ...
            0.92636 0.92728 0.92820 0.92898 0.92990 0.93082 0.93160 ...
            0.93252 0.93344 0.93436 0.93514 0.93606 0.93698 0.93776 ...
            0.93868 0.93960 0.94051 0.94143 0.94222 0.94313 0.94405 ...
            0.94497 0.94589 0.94667 0.94759 0.94851 0.94942 0.95034 ...
            0.95126 0.95218 0.95309 0.95401 0.95493 0.95571 0.95663 ...
            0.95755 0.95846 0.95938 0.96030 0.96122 0.96213 0.96305 ...
            0.96397 0.96488 0.96580 0.96685 0.96777 0.96868 0.96960 ...
            0.97052 0.97144 0.97235 0.97327 0.97419 0.97524 0.97615 ...
            0.97707 0.97799 0.97890 0.97995 0.98087 0.98179 0.98270 ...
            0.98375 0.98467 0.98559 0.98650 0.98755 0.98847 0.98939 ...
            0.99044 0.99135 0.99227 0.99332 0.99423 0.99515 0.99620 ...
            0.99712 0.99817 0.99908 1.00000 1.00105 1.00197 1.00301 ...
            1.00393 1.00498 1.00590 1.00694 1.00786 1.00891 1.00983 ...
            1.01088 1.01192 1.01284 1.01389 1.01481 1.01585 1.01690 ...
            1.01782 1.01887 1.01979 1.02083 1.02188 1.02280 1.02385 ...
            1.02490 1.02594 1.02686 1.02791 1.02896 1.03001 1.03092 ...
            1.03197 1.03302 1.03407 1.03512 1.03616 1.03708 1.03813 ...
            1.03918 1.04023 1.04127 1.04232 1.04337 1.04442 1.04547 ...
            1.04651 1.04756 1.04861 1.04966 1.05071 1.05176 1.05280 ...
            1.05385 1.05490 1.05595 1.05700 1.05805 1.05909 1.06014 ...
            1.06119 1.06224 1.06342 1.06447 1.06551 1.06656 1.06761 ...
            1.06879 1.06984 1.07089 1.07193 1.07311 1.07416 1.07521 ...
            1.07626 1.07744 1.07849 1.07953 1.08071 1.08176 1.08281 ...
            1.08399 1.08504 1.08622 1.08726 1.08844 1.08949 1.09054 ...
            1.09172 1.09277 1.09395 1.09499 1.09617 1.09735 1.09840 ...
            1.09958 1.10063 1.10181 1.10286 1.10404];
          
% fibra.Aeffs = 1e-12*spline(lamb, Aeff_ref*Aeff_1550, sinal.lambda);
% fibra.Aeffp = 1e-12*spline(lamb, Aeff_ref*Aeff_1550, bombeio.lambda);
             
%
fibra.Aeffs = 1e-12*1.81*ones(size(sinal.lambda));
fibra.Aeffp = 1e-12*1.81*ones(size(bombeio.lambda));

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%   Características da fibra para o cálculo do coeficiente de Rayleigh  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.KR = 60;   % (dB/km) constante que depende do material dopante da fibra (Assumido)
fibra.NA = 0.14; % abertura numerica da fibra (Assumido)
fibra.no = 1.468;  %NA^2/(2*deltaindice);  % indice de refracao do nucleo da fibra (Assumido)  


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%       Características da dispersão cromática da fibra                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

c = 299792.458; %km/s

% Dados retirados do datasheet da fibra
lambda0 = 1550;
S0 = -6.1959;              % Slope de fibra (ps/nm^2-km)- valor tirado do ITU-T G652  
D0 = -1216;                % Dispersao em 1550nm (ps/nm-km) - valor tirado do ITU-T G652  
ng = 1.46;                 % Índice de refração efetivo do grupo em lambda0

%Sinais
% Aproximação linear da curva de dispersão por um ponto e inclinação
Ds = (D0 + S0*(sinal.lambda - lambda0));   %(ps/nm-km) eq. tirada do ITU-T G652
% Expansão da série de Taylor para beta1
fibra.beta1s = ng/(1e3*c) + 1e-15*D0*(sinal.lambda - lambda0) + 1e-15*S0*(sinal.lambda - lambda0).^2;
% Parâmetro GVD (Eq. 1.2.11 - Agrawal 4ªed)
fibra.beta2s = -((sinal.lambda.^2).*Ds/(2*pi*c))*1e-27;
% GVD de alta ordem (Desenvolver beta3 = dbeta2/dw)
fibra.beta3s = 1e-39*((sinal.lambda.^3)/(2*pi*c)^2).*(2*Ds + sinal.lambda*S0);
% 
% %Bombeios
% Aproximação linear da curva de dispersão por um ponto e inclinação
Dp = (D0 + S0*(bombeio.lambda-lambda0));   %(ps/nm-km) eq. tirada do ITU-T G652
% Expansão da série de Taylor para beta1
fibra.beta1p = ng/(1e3*c) + 1e-15*D0*(bombeio.lambda - lambda0) + 1e-15*S0*(bombeio.lambda - lambda0).^2;
% Parâmetro GVD (Eq. 1.2.11 - Agrawal 4ªed)
fibra.beta2p = -((bombeio.lambda.^2).*Dp/(2*pi*c))*1e-27;
% GVD de alta ordem (Desenvolver beta3 = dbeta2/dw)
fibra.beta3p = 1e-39*((bombeio.lambda.^3)/(2*pi*c)^2).*(2*Dp + bombeio.lambda*S0);


% Parâmetro não linear Eq. 2.3.29 - Nonlinear fiber optics, 4ªed - Agrawal
n2 = 2.45*10^(-20);
fibra.gamas = 2*pi*n2./(1e-9*sinal.lambda.*fibra.Aeffs);
fibra.gamap = 2*pi*n2./(1e-9*bombeio.lambda.*fibra.Aeffp);
