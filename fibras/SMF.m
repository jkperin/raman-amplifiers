%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Entradas:
% bombeio =                         sinal =           
%    N_Bombeios: int(m)                     lambda: [1xn] 
%        lambda: [1xm]                           P: [1xn]
%             P: [1xm]                    N_Sinais: int(n)
%           Bwp: double                        Bws: double
%           FPL: double                        
%Saída:
% fibra =
%           L: double
%       alfas: [1xn]
%       alfap: [1xm]
%   alfasdBkm: [1xn]
%   alfapdBkm: [1xm]
% Crpicosinal: [1xn]
%  Crpicopump: [1xm]
%    Crnormal: [1xK]
%     sepfreq: [1xK]
%       Aeffs: [1xn]
%       Aeffp: [1xm]       
%          KR: double % Constante que depende do material dopante da fibra
%          NA: double % Abertura numérica da fibra
%          no: double % Índice de Refração do núcleo da fibra
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function fibra = SMF(bombeio, sinal)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               Atenuação                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
lamb  = 1400:1649;   % Usado para o calculo da atenuacao na fibra
nlamb = 1649 - 1400 + 1;
%
alfa = [0.3141 0.3092 0.3046 0.3004 0.2964 0.2928 0.2893 0.2861 0.2831 ...
        0.2802 0.2776 0.2751 0.2727 0.2704 0.2683 0.2662 0.2643 0.2625 ...
        0.2607 0.2590 0.2574 0.2558 0.2543 0.2529 0.2515 0.2502 0.2489 ...
        0.2476 0.2464 0.2452 0.2441 0.2430 0.2419 0.2409 0.2398 0.2388 ...
        0.2378 0.2369 0.2360 0.2350 0.2342 0.2333 0.2324 0.2316 0.2308 ...
        0.2299 0.2291 0.2284 0.2276 0.2268 0.2261 0.2254 0.2246 0.2239 ...
        0.2232 0.2225 0.2219 0.2212 0.2205 0.2199 0.2192 0.2186 0.2180 ...
        0.2174 0.2168 0.2162 0.2156 0.2150 0.2144 0.2138 0.2133 0.2127 ...
        0.2122 0.2116 0.2111 0.2105 0.2100 0.2095 0.2090 0.2085 0.2080 ...
        0.2075 0.2070 0.2065 0.2061 0.2056 0.2051 0.2047 0.2042 0.2038 ...
        0.2034 0.2029 0.2025 0.2021 0.2017 0.2013 0.2009 0.2005 0.2001 ...
        0.1997 0.1993 0.1990 0.1986 0.1982 0.1979 0.1975 0.1972 0.1969 ...
        0.1965 0.1962 0.1959 0.1956 0.1953 0.1950 0.1947 0.1944 0.1942 ...
        0.1939 0.1936 0.1934 0.1931 0.1929 0.1926 0.1924 0.1922 0.1920 ...
        0.1918 0.1916 0.1914 0.1912 0.1910 0.1909 0.1907 0.1905 0.1904 ...
        0.1903 0.1901 0.1900 0.1899 0.1898 0.1897 0.1896 0.1895 0.1895 ...
        0.1894 0.1893 0.1893 0.1893 0.1892 0.1892 0.1892 0.1892 0.1892 ...
        0.1893 0.1893 0.1893 0.1894 0.1895 0.1895 0.1896 0.1897 0.1898 ...
        0.1899 0.1901 0.1902 0.1904 0.1905 0.1907 0.1909 0.1911 0.1913 ...
        0.1916 0.1918 0.1921 0.1923 0.1926 0.1929 0.1932 0.1935 0.1939 ...
        0.1942 0.1946 0.1950 0.1954 0.1958 0.1962 0.1966 0.1971 0.1976 ...
        0.1981 0.1986 0.1991 0.1997 0.2002 0.2008 0.2014 0.2020 0.2026 ...
        0.2033 0.2040 0.2047 0.2054 0.2061 0.2068 0.2076 0.2084 0.2092 ...
        0.2101 0.2109 0.2118 0.2127 0.2136 0.2146 0.2155 0.2165 0.2176 ...
        0.2186 0.2197 0.2208 0.2219 0.2230 0.2242 0.2254 0.2266 0.2279 ...
        0.2292 0.2305 0.2318 0.2332 0.2346 0.2360 0.2375 0.2390 0.2405 ...
        0.2420 0.2436 0.2452 0.2469 0.2486 0.2503 0.2521 0.2539 0.2557 ...
        0.2575 0.2594 0.2614 0.2634 0.2654 0.2674 0.2695];
%
fibra.alfasdBkm = zeros(1,sinal.N_Sinais);
fibra.alfapdBkm = zeros(1,bombeio.N_Bombeios);

for k = 1:sinal.N_Sinais
  for i=1:nlamb-1
    if (lamb(i)<=(sinal.lambda(k)))&&(lamb(i+1)>=(sinal.lambda(k)))
      fibra.alfasdBkm(k)=alfa(i) + ((sinal.lambda(k) - lamb(i))*...
          (alfa(i + 1) - alfa(i))/(lamb(i + 1) - lamb(i)));
    end
  end
 end
%
for k = 1:bombeio.N_Bombeios
  for i=1:nlamb-1
    if (lamb(i)<=(bombeio.lambda(k)))&&(lamb(i+1)>=(bombeio.lambda(k)))
      fibra.alfapdBkm(k) = alfa(i) + ((bombeio.lambda(k) - lamb(i))*...
          (alfa(i + 1) - alfa(i))/(lamb(i + 1) - lamb(i)));
    end
  end
 end
%
fibra.alfas = fibra.alfasdBkm*log(10)*1e-4;     %(neper/m)
fibra.alfap = fibra.alfapdBkm*log(10)*1e-4;   %(neper/m)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                   Calculo do ganho de Raman                           %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

CRPICO_SMF = 0.4;
fibra.Crpicopump = CRPICO_SMF*1e-3*ones(1,bombeio.N_Bombeios);
fibra.Crpicosinal = CRPICO_SMF*1e-3*ones(1,sinal.N_Sinais);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%              Pontos da curva de ganho normalizada                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.Crnormal=[0.00000 0.04235 0.08747 0.12658 0.18108 0.22152 0.24789 0.27602 ...
                0.29008 0.31646 0.34810 0.36920 0.40963 0.46159 0.52836 0.63001 ...
                0.71755 0.78734 0.86769 0.90014 0.95566 1.00000 0.98412 0.93179 ...
                0.97850 0.93687 0.52954 0.30158 0.17941 0.18388 0.20439 0.22679 ...
                0.14241 0.09318 0.07560 0.07384 0.07560 0.07736 0.09845 0.14768 ...
                0.17053 0.15999 0.12131 0.07736 0.05098 0.04395 0.03868 0.03165 ...
                0.03165 0.02989 0.03516 0.04571 0.05978 0.06505 0.05450 0.03868 ...
                0.02813 0.02637 0.02813 0.03692 0.03692 0.02637 0.02110 0.01231 ...
                0.00879 0.01055 0.00176 0.00000];
        
fibra.sepfreq= [0.00000000 6.26866E11 1.25373E12 1.88060E12 2.50746E12 3.13433E12 ...
                3.76120E12 4.38806E12 5.01493E12 5.64179E12 6.26866E12 6.89553E12 ...
                7.52239E12 8.14926E12 8.77612E12 9.40299E12 1.00299E13 1.06567E13 ...
                1.12836E13 1.19105E13 1.25373E13 1.31642E13 1.37911E13 1.44179E13 ...
                1.50448E13 1.56717E13 1.62985E13 1.69254E13 1.75522E13 1.81791E13 ...
                1.88060E13 1.94328E13 2.00597E13 2.06866E13 2.13134E13 2.19403E13 ...
                2.25672E13 2.31940E13 2.38209E13 2.44478E13 2.50746E13 2.57015E13 ...
                2.63284E13 2.69552E13 2.75821E13 2.82090E13 2.88358E13 2.94627E13 ...
                3.00896E13 3.07164E13 3.13433E13 3.19702E13 3.25970E13 3.32239E13 ...
                3.38508E13 3.44776E13 3.51045E13 3.57314E13 3.63582E13 3.69851E13 ...
                3.76120E13 3.82388E13 3.88657E13 3.94926E13 4.01194E13 4.07463E13 ...
                4.13732E13 4.2E13]; 
                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                             Área Efetiva                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Aeff_ref = [66.29 66.35 66.41 66.47 66.53 66.59 66.65 66.71 66.77 66.83 66.89 ...
            66.95 67.01 67.07 67.14 67.20 67.26 67.32 67.38 67.44 67.50 67.57 ...
            67.63 67.69 67.75 67.81 67.88 67.94 68.00 68.06 68.13 68.19 68.25 ...
            68.32 68.38 68.44 68.50 68.57 68.63 68.69 68.76 68.82 68.88 68.95 ...
            69.01 69.08 69.14 69.20 69.27 69.33 69.40 69.46 69.53 69.59 69.66 ...
            69.72 69.79 69.85 69.92 69.98 70.05 70.11 70.18 70.24 70.31 70.37 ...
            70.44 70.51 70.57 70.64 70.70 70.77 70.84 70.90 70.97 71.04 71.10 ...
            71.17 71.24 71.31 71.37 71.44 71.51 71.57 71.64 71.71 71.78 71.85 ...
            71.91 71.98 72.05 72.12 72.19 72.25 72.32 72.39 72.46 72.53 72.60 ...
            72.67 72.74 72.81 72.88 72.94 73.01 73.08 73.15 73.22 73.29 73.36 ...
            73.43 73.50 73.57 73.64 73.71 73.79 73.86 73.93 74.00 74.07 74.14 ...
            74.21 74.28 74.35 74.43 74.50 74.57 74.64 74.71 74.79 74.86 74.93 ...
            75.00 75.08 75.15 75.22 75.29 75.37 75.44 75.51 75.59 75.66 75.73 ...
            75.81 75.88 75.95 76.03 76.10 76.18 76.25 76.32 76.40 76.47 76.55 ...
            76.62 76.70 76.77 76.85 76.92 77.00 77.07 77.15 77.23 77.30 77.38 ...
            77.45 77.53 77.61 77.68 77.76 77.83 77.91 77.99 78.06 78.14 78.22 ...
            78.30 78.37 78.45 78.53 78.61 78.68 78.76 78.84 78.92 79.00 79.08 ...
            79.15 79.23 79.31 79.39 79.47 79.55 79.63 79.71 79.79 79.87 79.95 ...
            80.03 80.11 80.19 80.27 80.35 80.43 80.51 80.59 80.67 80.75 80.83 ...
            80.91 80.99 81.07 81.16 81.24 81.32 81.40 81.48 81.57 81.65 81.73 ...
            81.81 81.90 81.98 82.06 82.14 82.23 82.31 82.39 82.48 82.56 82.64 ...
            82.73 82.81 82.90 82.98 83.07 83.15 83.23 83.32 83.40 83.49 83.57 ...
            83.66 83.75 83.83 83.92 84.00 84.09 84.17 84.26];
    
poly_Aeff = polyfit(lamb, Aeff_ref, 2);   

fibra.Aeffs = 1e-12*polyval(poly_Aeff, sinal.lambda);
fibra.Aeffp = 1e-12*polyval(poly_Aeff, bombeio.lambda);
                
                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%   Características da fibra para o cálculo do coeficiente de Rayleigh  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.KR = 60;   % (dB/km) constante que depende do material dopante da fibra (Assumido)
fibra.NA = 0.14; % abertura numerica da fibra (Assumido)
fibra.no = 1.468;  %NA^2/(2*deltaindice);  % indice de refracao do nucleo da fibra (Assumido)                
