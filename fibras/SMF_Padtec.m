%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Entradas:
% bombeio =                         sinal =           
%    N_Bombeios: int(m)                     lambda: [1xn] 
%        lambda: [1xm]                           P: [1xn]
%             P: [1xm]                    N_Sinais: int(n)
%           Bwp: double                        Bws: double
%           FPL: double                        
%Saída:
% fibra =
%           L: double
%       alfas: [1xn]
%       alfap: [1xm]
%   alfasdBkm: [1xn]
%   alfapdBkm: [1xm]
% Crpicosinal: [1xn]
%  Crpicopump: [1xm]
%    Crnormal: [1xK]
%     sepfreq: [1xK]
%       Aeffs: [1xn]
%       Aeffp: [1xm]       
%          KR: double % Constante que depende do material dopante da fibra
%          NA: double % Abertura numérica da fibra
%          no: double % Índice de Refração do núcleo da fibra
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function fibra = SMF_Padtec(bombeio, sinal)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               Atenuação                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% sepfreq = 1400:20:1680;
% 
% SMF_Padtec = [0.370 0.290 0.220 0.215 0.212 0.205 0.192 0.186 0.182 0.181 ...
%     0.184 0.193 0.208 0.234 0.276];
% 
% polySMF_Padtec = polyfit(sepfreq,SMF_Padtec,4);

polySMF_Padtec = [3.77293791092948e-10,-2.33573525003249e-06,0.00542172459972225,-5.59260296901828,2163.27470767991];

% fibra.alfapdBkm = [0.303 0.232 0.227 0.224];

fibra.alfasdBkm = polyval(polySMF_Padtec, sinal.lambda);
fibra.alfapdBkm = polyval(polySMF_Padtec, bombeio.lambda);

fibra.alfas = fibra.alfasdBkm*log(10)*1e-4;   %(neper/m)
fibra.alfap = fibra.alfapdBkm*log(10)*1e-4;   %(neper/m)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                   Calculo do ganho de Raman                           %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Calculo do ganho de Raman%%%%%%%%%%%%%%
lambdap_ref=1449;  %bombeio de referencia utilizado para obter o Cr de pico
Crpico_refp=0.72;
Crpico_up_refp=Crpico_refp*1e-3;  % (1/Wm) unidade padrao

fibra.Crpicopump = lambdap_ref*Crpico_up_refp./bombeio.lambda;

fibra.Crpicosinal = lambdap_ref*Crpico_up_refp./sinal.lambda;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PONTOS DA CURVA DE GANHO NORMALIZADA BOMBEIO 1
lambdaref =1500e-9;
seplamb = (1e-9)*[0 4.59999999999991 6.51999999999998 8.44000000000006 10.3599999999999 12.2800000000000 14.2000000000000 16.1199999999999 18.0400000000000 19.9600000000000 21.8800000000001 23.8000000000000 25.7200000000000 27.6400000000001 29.5599999999999 31.4800000000000 33.4000000000001 35.3199999999999 37.2400000000000 39.1600000000001 41.0799999999999 43 44.9200000000001 46.8399999999999 48.7600000000000 50.6800000000001 52.5999999999999 54.5200000000000 56.4400000000001 58.3599999999999 60.2800000000000 62.2000000000000 64.1199999999999 66.0400000000000 67.9600000000000 69.8800000000001 71.8000000000000 73.7200000000000 75.6400000000001 77.5600000000000 79.4800000000000 81.4000000000001 83.3199999999999 85.2400000000000 87.1600000000001 89.0799999999999 91 92.9200000000001 94.8399999999999 96.7600000000000 98.6800000000001 100.600000000000 102.520000000000 104.440000000000 106.360000000000 108.280000000000 110.200000000000 112.120000000000 114.040000000000 115.960000000000 117.880000000000 119.800000000000 121.720000000000 123.640000000000 125.560000000000 127.480000000000 129.400000000000 131.320000000000 133.240000000000 135.160000000000 137.080000000000 139 140.920000000000 142.840000000000 144.760000000000 146.680000000000 148.600000000000 150.520000000000];
sepfreq = 2.99792458e8*seplamb./((lambdaref)^2);
Crnormal = [0 0.244455605318343 0.374110588272054 0.460468578378575 0.496935473780308 0.502226934182390 0.499804313578240 0.500610552528822 0.487753056974596 0.475335225942805 0.463340219424210 0.461105178875984 0.441367143463441 0.425010833176048 0.405975663251569 0.388239751205765 0.386455951581426 0.377920107961879 0.373594092258801 0.366100228546543 0.367366880110304 0.370339469397537 0.370766084000312 0.373938343643152 0.381153577144850 0.391471364848206 0.402346288990232 0.410015240506613 0.426186805424161 0.436415332326273 0.459198012836869 0.475116376377562 0.498539989263987 0.518680594557442 0.542375420696101 0.562470823974132 0.587759963680601 0.617305291888685 0.642687717317019 0.676705957674191 0.702910450136186 0.738584178120798 0.781267934551605 0.818087957945747 0.841395141645195 0.872167702203097 0.897015608414816 0.921934357451561 0.949948365876347 0.979039017448052 0.994031163465779 0.972971232891650 0.930464911031240 0.874178256400529 0.839846661157916 0.845278845160289 0.844889669484521 0.752488730173584 0.595936519255937 0.438732695132530 0.324937623618762 0.255799681855502 0.216520987930793 0.197333127953650 0.175670970266464 0.159147565664386 0.156566917052851 0.154846003176182 0.159184214964859 0.166379570938700 0.176563122226337 0.172663285274324 0.151739972143480 0.122772189202732 0.105268879438250 0.0896602612564298 0.0862382629151766 0.0768422371100025];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%              Pontos da curva de ganho normalizada                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.Crnormal = Crnormal;
        
fibra.sepfreq= sepfreq; 
                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                             Área Efetiva                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
lamb = 1400:1649;
Aeff_ref = [66.29 66.35 66.41 66.47 66.53 66.59 66.65 66.71 66.77 66.83 66.89 ...
            66.95 67.01 67.07 67.14 67.20 67.26 67.32 67.38 67.44 67.50 67.57 ...
            67.63 67.69 67.75 67.81 67.88 67.94 68.00 68.06 68.13 68.19 68.25 ...
            68.32 68.38 68.44 68.50 68.57 68.63 68.69 68.76 68.82 68.88 68.95 ...
            69.01 69.08 69.14 69.20 69.27 69.33 69.40 69.46 69.53 69.59 69.66 ...
            69.72 69.79 69.85 69.92 69.98 70.05 70.11 70.18 70.24 70.31 70.37 ...
            70.44 70.51 70.57 70.64 70.70 70.77 70.84 70.90 70.97 71.04 71.10 ...
            71.17 71.24 71.31 71.37 71.44 71.51 71.57 71.64 71.71 71.78 71.85 ...
            71.91 71.98 72.05 72.12 72.19 72.25 72.32 72.39 72.46 72.53 72.60 ...
            72.67 72.74 72.81 72.88 72.94 73.01 73.08 73.15 73.22 73.29 73.36 ...
            73.43 73.50 73.57 73.64 73.71 73.79 73.86 73.93 74.00 74.07 74.14 ...
            74.21 74.28 74.35 74.43 74.50 74.57 74.64 74.71 74.79 74.86 74.93 ...
            75.00 75.08 75.15 75.22 75.29 75.37 75.44 75.51 75.59 75.66 75.73 ...
            75.81 75.88 75.95 76.03 76.10 76.18 76.25 76.32 76.40 76.47 76.55 ...
            76.62 76.70 76.77 76.85 76.92 77.00 77.07 77.15 77.23 77.30 77.38 ...
            77.45 77.53 77.61 77.68 77.76 77.83 77.91 77.99 78.06 78.14 78.22 ...
            78.30 78.37 78.45 78.53 78.61 78.68 78.76 78.84 78.92 79.00 79.08 ...
            79.15 79.23 79.31 79.39 79.47 79.55 79.63 79.71 79.79 79.87 79.95 ...
            80.03 80.11 80.19 80.27 80.35 80.43 80.51 80.59 80.67 80.75 80.83 ...
            80.91 80.99 81.07 81.16 81.24 81.32 81.40 81.48 81.57 81.65 81.73 ...
            81.81 81.90 81.98 82.06 82.14 82.23 82.31 82.39 82.48 82.56 82.64 ...
            82.73 82.81 82.90 82.98 83.07 83.15 83.23 83.32 83.40 83.49 83.57 ...
            83.66 83.75 83.83 83.92 84.00 84.09 84.17 84.26];
    
poly_Aeff = polyfit(lamb, Aeff_ref, 2);   

fibra.Aeffs = 1e-12*polyval(poly_Aeff, sinal.lambda);
fibra.Aeffp = 1e-12*polyval(poly_Aeff, bombeio.lambda);
                
                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%   Características da fibra para o cálculo do coeficiente de Rayleigh  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fibra.KR = 60;   % (dB/km) constante que depende do material dopante da fibra (Assumido)
fibra.NA = 0.14; % abertura numerica da fibra (Assumido)
fibra.no = 1.468;  %NA^2/(2*deltaindice);  % indice de refracao do nucleo da fibra (Assumido)                
